# åˆçº§å‰ç«¯ä¸‰å¤©å¤ä¹ è®¡åˆ’ - ç¬¬å››å¤©ï¼ˆè¿›é˜¶ç‰ˆï¼‰

> ğŸ“… **å­¦ä¹ æ—¶é—´**ï¼šç¬¬å››å¤©ï¼ˆè¿›é˜¶å­¦ä¹ ï¼‰ | **ç›®æ ‡**ï¼šæ·±å…¥ç†è§£æ ¸å¿ƒåŸç† | **å»ºè®®æ—¶é•¿**ï¼š6-8å°æ—¶
> âš ï¸ **éš¾åº¦è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŒ…å«è¾ƒæ·±å…¥çš„åº•å±‚åŸç†ï¼Œå»ºè®®åœ¨æŒæ¡å‰ä¸‰å¤©åŸºç¡€åå­¦ä¹ 

## ğŸ“š ä»Šæ—¥å­¦ä¹ å†…å®¹

| æ¨¡å— | æ ¸å¿ƒçŸ¥è¯†ç‚¹ | é‡è¦ç¨‹åº¦ | é¢„è®¡æ—¶é•¿ |
|------|-----------|---------|----------|
| **Vueå“åº”å¼åŸç†** | Object.definePropertyã€Proxyåº•å±‚å®ç° | â­â­â­â­â­ | 2.5å°æ—¶ |
| **JavaScriptè¿›é˜¶** | call/apply/bindå®ç°ã€é—­åŒ…é«˜çº§åº”ç”¨ | â­â­â­â­â­ | 2.5å°æ—¶ |
| **Promiseæ·±å…¥** | é“¾å¼è°ƒç”¨ã€æ‰§è¡Œé¡ºåºåˆ†æ | â­â­â­â­â­ | 2å°æ—¶ |
| **äº‹ä»¶æœºåˆ¶è¿›é˜¶** | passiveä¼˜åŒ–ã€keep-aliveé’©å­ | â­â­â­â­ | 1å°æ—¶ |

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šVueå“åº”å¼åŸç†æ·±å…¥

## ä¸€ã€Vue2å“åº”å¼åŸç†åº•å±‚å®ç° â­â­â­â­â­

### 1. Object.definePropertyå®Œæ•´å®ç°

**æ ¸å¿ƒåŸç†ï¼š** æ•°æ®åŠ«æŒ + å‘å¸ƒè®¢é˜…æ¨¡å¼

```javascript
// 1. ä¾èµ–æ”¶é›†å™¨ï¼ˆDepï¼‰
class Dep {
  constructor() {
    this.subscribers = []; // è®¢é˜…è€…åˆ—è¡¨
  }

  // æ·»åŠ è®¢é˜…è€…
  addSub(watcher) {
    this.subscribers.push(watcher);
  }

  // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…æ›´æ–°
  notify() {
    this.subscribers.forEach(watcher => watcher.update());
  }

  // ä¾èµ–æ”¶é›†
  depend() {
    if (Dep.target) {
      this.addSub(Dep.target);
    }
  }
}

// å½“å‰æ­£åœ¨æ”¶é›†ä¾èµ–çš„Watcher
Dep.target = null;

// 2. è§‚å¯Ÿè€…ï¼ˆWatcherï¼‰
class Watcher {
  constructor(vm, key, updateFn) {
    this.vm = vm;
    this.key = key;
    this.updateFn = updateFn;

    // é¦–æ¬¡è¯»å–ï¼Œè§¦å‘ä¾èµ–æ”¶é›†
    Dep.target = this;
    this.value = vm[key]; // è§¦å‘getter
    Dep.target = null;
  }

  update() {
    const newValue = this.vm[this.key];
    if (newValue !== this.value) {
      this.value = newValue;
      this.updateFn(newValue);
    }
  }
}

// 3. å“åº”å¼è½¬æ¢
function defineReactive(obj, key, val) {
  const dep = new Dep(); // æ¯ä¸ªå±æ€§éƒ½æœ‰è‡ªå·±çš„dep

  // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
  if (typeof val === 'object' && val !== null) {
    observe(val);
  }

  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get() {
      console.log(`è¯»å– ${key}: ${val}`);
      // ä¾èµ–æ”¶é›†
      dep.depend();
      return val;
    },
    set(newVal) {
      if (newVal === val) return;
      console.log(`è®¾ç½® ${key}: ${val} -> ${newVal}`);
      val = newVal;

      // æ–°å€¼æ˜¯å¯¹è±¡ï¼Œéœ€è¦ç»§ç»­è§‚å¯Ÿ
      if (typeof newVal === 'object' && newVal !== null) {
        observe(newVal);
      }

      // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
      dep.notify();
    }
  });
}

// 4. è§‚å¯Ÿå¯¹è±¡
function observe(obj) {
  if (typeof obj !== 'object' || obj === null) {
    return;
  }

  Object.keys(obj).forEach(key => {
    defineReactive(obj, key, obj[key]);
  });
}

// 5. Vueå®ä¾‹ç®€åŒ–ç‰ˆ
class Vue {
  constructor(options) {
    this.$data = options.data;

    // æ•°æ®ä»£ç†ï¼švm.xxx -> vm.$data.xxx
    Object.keys(this.$data).forEach(key => {
      Object.defineProperty(this, key, {
        get() {
          return this.$data[key];
        },
        set(newVal) {
          this.$data[key] = newVal;
        }
      });
    });

    // è§‚å¯Ÿæ•°æ®
    observe(this.$data);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const vm = new Vue({
  data: {
    count: 0,
    user: {
      name: 'å¼ ä¸‰',
      age: 20
    }
  }
});

// åˆ›å»ºWatcherè§‚å¯Ÿcountå˜åŒ–
new Watcher(vm, 'count', (newValue) => {
  console.log(`countæ›´æ–°ä¸º: ${newValue}`);
});

vm.count = 1; // è¾“å‡ºï¼šè®¾ç½® count: 0 -> 1ï¼Œcountæ›´æ–°ä¸º: 1
vm.count = 2; // è¾“å‡ºï¼šè®¾ç½® count: 1 -> 2ï¼Œcountæ›´æ–°ä¸º: 2
```

### 2. Vue2å“åº”å¼çš„å±€é™æ€§

```javascript
const vm = new Vue({
  data: {
    obj: { name: 'å¼ ä¸‰' },
    arr: [1, 2, 3]
  }
});

// âŒ é—®é¢˜1ï¼šæ— æ³•ç›‘å¬æ–°å¢å±æ€§
vm.obj.age = 20; // ä¸ä¼šè§¦å‘æ›´æ–°
console.log(vm.obj.age); // 20ï¼Œä½†è§†å›¾ä¸æ›´æ–°

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨Vue.set
Vue.set(vm.obj, 'age', 20);
// æˆ–
vm.$set(vm.obj, 'age', 20);

// âŒ é—®é¢˜2ï¼šæ— æ³•ç›‘å¬æ•°ç»„ç´¢å¼•å˜åŒ–
vm.arr[0] = 100; // ä¸ä¼šè§¦å‘æ›´æ–°

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ•°ç»„å˜å¼‚æ–¹æ³•
vm.arr.splice(0, 1, 100); // è§¦å‘æ›´æ–°
vm.arr.push(4); // è§¦å‘æ›´æ–°

// âŒ é—®é¢˜3ï¼šæ— æ³•ç›‘å¬æ•°ç»„lengthå˜åŒ–
vm.arr.length = 0; // ä¸ä¼šè§¦å‘æ›´æ–°

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨splice
vm.arr.splice(0); // æ¸…ç©ºæ•°ç»„å¹¶è§¦å‘æ›´æ–°
```

**Vue2æ•°ç»„å¤„ç†æ–¹æ¡ˆï¼š**
```javascript
// Vue2é‡å†™äº†æ•°ç»„çš„7ä¸ªå˜å¼‚æ–¹æ³•
const arrayMethods = Object.create(Array.prototype);
const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
];

methodsToPatch.forEach(method => {
  const original = Array.prototype[method];

  Object.defineProperty(arrayMethods, method, {
    value: function(...args) {
      // è°ƒç”¨åŸå§‹æ–¹æ³•
      const result = original.apply(this, args);

      // è§¦å‘æ›´æ–°
      const ob = this.__ob__;
      let inserted;

      // æ–°å¢çš„å…ƒç´ éœ€è¦ç»§ç»­è§‚å¯Ÿ
      switch (method) {
        case 'push':
        case 'unshift':
          inserted = args;
          break;
        case 'splice':
          inserted = args.slice(2);
          break;
      }

      if (inserted) ob.observeArray(inserted);

      // é€šçŸ¥æ›´æ–°
      ob.dep.notify();

      return result;
    }
  });
});
```

---

## äºŒã€Vue3å“åº”å¼åŸç†åº•å±‚å®ç° â­â­â­â­â­

### 1. Proxyå®Œæ•´å®ç°

```javascript
// 1. ä¾èµ–æ˜ å°„è¡¨
const targetMap = new WeakMap();

// 2. å½“å‰æ´»è·ƒçš„effect
let activeEffect = null;

// 3. ä¾èµ–æ”¶é›†
function track(target, key) {
  if (!activeEffect) return;

  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }

  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }

  dep.add(activeEffect);
}

// 4. è§¦å‘æ›´æ–°
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;

  const dep = depsMap.get(key);
  if (dep) {
    dep.forEach(effect => effect());
  }
}

// 5. å“åº”å¼è½¬æ¢
function reactive(target) {
  if (typeof target !== 'object' || target === null) {
    return target;
  }

  return new Proxy(target, {
    get(target, key, receiver) {
      console.log(`è¯»å– ${key}`);
      const result = Reflect.get(target, key, receiver);

      // ä¾èµ–æ”¶é›†
      track(target, key);

      // æ‡’ä»£ç†ï¼šåªæœ‰è®¿é—®åˆ°çš„åµŒå¥—å¯¹è±¡æ‰ä¼šè¢«ä»£ç†
      if (typeof result === 'object' && result !== null) {
        return reactive(result);
      }

      return result;
    },

    set(target, key, value, receiver) {
      const oldValue = target[key];
      const result = Reflect.set(target, key, value, receiver);

      // å€¼å˜åŒ–æ‰è§¦å‘æ›´æ–°
      if (oldValue !== value) {
        console.log(`è®¾ç½® ${key}: ${oldValue} -> ${value}`);
        trigger(target, key);
      }

      return result;
    },

    deleteProperty(target, key) {
      const hadKey = Object.prototype.hasOwnProperty.call(target, key);
      const result = Reflect.deleteProperty(target, key);

      if (hadKey && result) {
        console.log(`åˆ é™¤ ${key}`);
        trigger(target, key);
      }

      return result;
    }
  });
}

// 6. å‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  activeEffect = fn;
  fn(); // ç«‹å³æ‰§è¡Œï¼Œè§¦å‘ä¾èµ–æ”¶é›†
  activeEffect = null;
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({
  count: 0,
  user: {
    name: 'å¼ ä¸‰',
    age: 20
  },
  arr: [1, 2, 3]
});

// åˆ›å»ºå‰¯ä½œç”¨
effect(() => {
  console.log(`countçš„å€¼æ˜¯: ${state.count}`);
});
// è¾“å‡ºï¼šè¯»å– countï¼Œcountçš„å€¼æ˜¯: 0

state.count = 1;
// è¾“å‡ºï¼šè®¾ç½® count: 0 -> 1ï¼Œè¯»å– countï¼Œcountçš„å€¼æ˜¯: 1

// âœ… ä¼˜åŠ¿1ï¼šå¯ä»¥ç›‘å¬æ–°å¢å±æ€§
state.user.gender = 'ç”·'; // è‡ªåŠ¨è§¦å‘æ›´æ–°

// âœ… ä¼˜åŠ¿2ï¼šå¯ä»¥ç›‘å¬æ•°ç»„ç´¢å¼•å˜åŒ–
state.arr[0] = 100; // è‡ªåŠ¨è§¦å‘æ›´æ–°

// âœ… ä¼˜åŠ¿3ï¼šå¯ä»¥ç›‘å¬æ•°ç»„lengthå˜åŒ–
state.arr.length = 0; // è‡ªåŠ¨è§¦å‘æ›´æ–°

// âœ… ä¼˜åŠ¿4ï¼šå¯ä»¥ç›‘å¬åˆ é™¤æ“ä½œ
delete state.user.age; // è‡ªåŠ¨è§¦å‘æ›´æ–°
```

### 2. refçš„å®ç°åŸç†

```javascript
function ref(value) {
  return {
    _isRef: true,
    _value: value,

    get value() {
      track(this, 'value');
      return this._value;
    },

    set value(newValue) {
      if (newValue !== this._value) {
        this._value = newValue;
        trigger(this, 'value');
      }
    }
  };
}

// ä½¿ç”¨
const count = ref(0);

effect(() => {
  console.log(`count: ${count.value}`);
});

count.value = 1; // è§¦å‘æ›´æ–°
```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šJavaScriptè¿›é˜¶æ·±å…¥

## ä¸€ã€call/apply/bindå®ç°åŸç† â­â­â­â­â­

### 1. æ‰‹å†™call

```javascript
Function.prototype.myCall = function(context, ...args) {
  // 1. å¤„ç†contextï¼ˆnull/undefinedæŒ‡å‘windowï¼‰
  context = context || window;

  // 2. å°†å‡½æ•°è®¾ç½®ä¸ºcontextçš„å±æ€§
  const fnSymbol = Symbol('fn'); // ä½¿ç”¨Symbolé¿å…å±æ€§åå†²çª
  context[fnSymbol] = this;

  // 3. è°ƒç”¨å‡½æ•°
  const result = context[fnSymbol](...args);

  // 4. åˆ é™¤ä¸´æ—¶å±æ€§
  delete context[fnSymbol];

  // 5. è¿”å›ç»“æœ
  return result;
};

// æµ‹è¯•
function greet(greeting, punctuation) {
  console.log(`${greeting}, æˆ‘æ˜¯${this.name}${punctuation}`);
}

const user = { name: 'å¼ ä¸‰' };

greet.myCall(user, 'ä½ å¥½', '!');
// è¾“å‡ºï¼šä½ å¥½, æˆ‘æ˜¯å¼ ä¸‰!
```

### 2. æ‰‹å†™apply

```javascript
Function.prototype.myApply = function(context, argsArray) {
  // 1. å¤„ç†context
  context = context || window;

  // 2. å¤„ç†å‚æ•°ï¼ˆapplyæ¥æ”¶æ•°ç»„ï¼‰
  argsArray = argsArray || [];

  // 3. å°†å‡½æ•°è®¾ç½®ä¸ºcontextçš„å±æ€§
  const fnSymbol = Symbol('fn');
  context[fnSymbol] = this;

  // 4. è°ƒç”¨å‡½æ•°ï¼ˆå±•å¼€æ•°ç»„ï¼‰
  const result = context[fnSymbol](...argsArray);

  // 5. åˆ é™¤ä¸´æ—¶å±æ€§
  delete context[fnSymbol];

  // 6. è¿”å›ç»“æœ
  return result;
};

// æµ‹è¯•
const numbers = [5, 6, 2, 3, 7];
const max = Math.max.myApply(null, numbers);
console.log(max); // 7
```

### 3. æ‰‹å†™bind

```javascript
Function.prototype.myBind = function(context, ...bindArgs) {
  const fn = this;

  // è¿”å›æ–°å‡½æ•°
  return function(...callArgs) {
    // åˆå¹¶å‚æ•°ï¼šbindæ—¶çš„å‚æ•° + è°ƒç”¨æ—¶çš„å‚æ•°
    return fn.apply(context, [...bindArgs, ...callArgs]);
  };
};

// æµ‹è¯•
const user = {
  name: 'å¼ ä¸‰',
  greet(greeting, time) {
    console.log(`${greeting}, ${this.name}! ç°åœ¨æ˜¯${time}`);
  }
};

const boundGreet = user.greet.myBind(user, 'æ—©ä¸Šå¥½');
boundGreet('8ç‚¹');
// è¾“å‡ºï¼šæ—©ä¸Šå¥½, å¼ ä¸‰! ç°åœ¨æ˜¯8ç‚¹
```

### 4. æ”¯æŒnewçš„bindå®ç°ï¼ˆå®Œæ•´ç‰ˆï¼‰

```javascript
Function.prototype.myBind = function(context, ...bindArgs) {
  const fn = this;

  const boundFunction = function(...callArgs) {
    // åˆ¤æ–­æ˜¯å¦é€šè¿‡newè°ƒç”¨
    // å¦‚æœæ˜¯newè°ƒç”¨ï¼ŒthisæŒ‡å‘æ–°åˆ›å»ºçš„å®ä¾‹
    // å¦åˆ™ï¼ŒthisæŒ‡å‘ç»‘å®šçš„context
    return fn.apply(
      this instanceof boundFunction ? this : context,
      [...bindArgs, ...callArgs]
    );
  };

  // ç»§æ‰¿åŸå‡½æ•°çš„åŸå‹
  boundFunction.prototype = Object.create(fn.prototype);

  return boundFunction;
};

// æµ‹è¯•newçš„æƒ…å†µ
function Person(name, age) {
  this.name = name;
  this.age = age;
}

const BoundPerson = Person.myBind(null, 'å¼ ä¸‰');
const person = new BoundPerson(20);
console.log(person.name); // å¼ ä¸‰
console.log(person.age);  // 20
```

---

## äºŒã€é—­åŒ…é«˜çº§åº”ç”¨ â­â­â­â­â­

### 1. æ¨¡å—åŒ–æ¨¡å¼

```javascript
const CounterModule = (function() {
  // ç§æœ‰å˜é‡
  let count = 0;
  let history = [];

  // ç§æœ‰æ–¹æ³•
  function log(action, value) {
    history.push({ action, value, time: Date.now() });
  }

  // å…¬å¼€API
  return {
    increment() {
      count++;
      log('increment', count);
      return count;
    },

    decrement() {
      count--;
      log('decrement', count);
      return count;
    },

    getCount() {
      return count;
    },

    getHistory() {
      return [...history]; // è¿”å›å‰¯æœ¬ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹
    },

    reset() {
      count = 0;
      history = [];
      log('reset', 0);
    }
  };
})();

// ä½¿ç”¨
console.log(CounterModule.increment()); // 1
console.log(CounterModule.increment()); // 2
console.log(CounterModule.decrement()); // 1
console.log(CounterModule.getHistory());
// [
//   { action: 'increment', value: 1, time: ... },
//   { action: 'increment', value: 2, time: ... },
//   { action: 'decrement', value: 1, time: ... }
// ]

// âŒ æ— æ³•ç›´æ¥è®¿é—®ç§æœ‰å˜é‡
console.log(CounterModule.count); // undefined
```

### 2. å‡½æ•°æŸ¯é‡ŒåŒ–ï¼ˆCurryï¼‰

```javascript
// é€šç”¨æŸ¯é‡ŒåŒ–å‡½æ•°
function curry(fn) {
  return function curried(...args) {
    // å‚æ•°å¤Ÿäº†ï¼Œæ‰§è¡ŒåŸå‡½æ•°
    if (args.length >= fn.length) {
      return fn.apply(this, args);
    }

    // å‚æ•°ä¸å¤Ÿï¼Œè¿”å›æ–°å‡½æ•°ç»§ç»­æ”¶é›†å‚æ•°
    return function(...nextArgs) {
      return curried.apply(this, [...args, ...nextArgs]);
    };
  };
}

// ç¤ºä¾‹1ï¼šç®€å•çš„åŠ æ³•å‡½æ•°
function add(a, b, c) {
  return a + b + c;
}

const curriedAdd = curry(add);

console.log(curriedAdd(1)(2)(3));       // 6
console.log(curriedAdd(1, 2)(3));       // 6
console.log(curriedAdd(1)(2, 3));       // 6
console.log(curriedAdd(1, 2, 3));       // 6

// ç¤ºä¾‹2ï¼šå®é™…åº”ç”¨ - æ—¥å¿—å‡½æ•°
function log(level, time, message) {
  console.log(`[${level}] ${time}: ${message}`);
}

const curriedLog = curry(log);

// åˆ›å»ºä¸“é—¨çš„æ—¥å¿—å‡½æ•°
const errorLog = curriedLog('ERROR');
const errorLogToday = errorLog(new Date().toISOString());

errorLogToday('æ•°æ®åº“è¿æ¥å¤±è´¥');
errorLogToday('æœåŠ¡å™¨å´©æºƒ');
// è¾“å‡ºï¼š
// [ERROR] 2024-01-01T12:00:00.000Z: æ•°æ®åº“è¿æ¥å¤±è´¥
// [ERROR] 2024-01-01T12:00:00.000Z: æœåŠ¡å™¨å´©æºƒ
```

### 3. å‡½æ•°è®°å¿†ï¼ˆMemoizationï¼‰

```javascript
function memoize(fn) {
  const cache = new Map();

  return function(...args) {
    const key = JSON.stringify(args);

    if (cache.has(key)) {
      console.log('ä»ç¼“å­˜è¯»å–');
      return cache.get(key);
    }

    console.log('è®¡ç®—æ–°ç»“æœ');
    const result = fn.apply(this, args);
    cache.set(key, result);
    return result;
  };
}

// ç¤ºä¾‹ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—
function fibonacci(n) {
  if (n <= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}

const memoizedFib = memoize(fibonacci);

console.log(memoizedFib(40)); // ç¬¬ä¸€æ¬¡ï¼šè®¡ç®—æ–°ç»“æœï¼Œè€—æ—¶è¾ƒé•¿
console.log(memoizedFib(40)); // ç¬¬äºŒæ¬¡ï¼šä»ç¼“å­˜è¯»å–ï¼Œç¬é—´è¿”å›
```

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šPromiseæ·±å…¥ç†è§£

## ä¸€ã€Promiseé“¾å¼è°ƒç”¨æ‰§è¡Œé¡ºåº â­â­â­â­â­

### 1. åŸºç¡€æ‰§è¡Œé¡ºåº

```javascript
console.log('1');

new Promise((resolve, reject) => {
  console.log('2'); // Promiseæ„é€ å‡½æ•°æ˜¯åŒæ­¥çš„
  resolve('æˆåŠŸ');
  console.log('3'); // resolveåçš„ä»£ç ä»ä¼šæ‰§è¡Œ
}).then(res => {
  console.log('4'); // thenæ˜¯å¾®ä»»åŠ¡
});

console.log('5');

// è¾“å‡ºé¡ºåºï¼š1 -> 2 -> 3 -> 5 -> 4
```

### 2. å¤šå±‚thené“¾å¼è°ƒç”¨

```javascript
Promise.resolve()
  .then(() => {
    console.log('1');
    return Promise.resolve('2');
  })
  .then(res => {
    console.log(res);
  });

Promise.resolve()
  .then(() => {
    console.log('3');
  })
  .then(() => {
    console.log('4');
  })
  .then(() => {
    console.log('5');
  });

// è¾“å‡ºé¡ºåºï¼š1 -> 3 -> 4 -> 5 -> 2
// åŸå› ï¼šreturn Promise.resolve()ä¼šå¤šä¸€ä¸ªå¾®ä»»åŠ¡
```

**è¯¦ç»†åˆ†æï¼š**
```javascript
// ç¬¬ä¸€è½®å¾®ä»»åŠ¡
Promise.resolve().then() // å¾®ä»»åŠ¡1
Promise.resolve().then() // å¾®ä»»åŠ¡2

// æ‰§è¡Œå¾®ä»»åŠ¡1ï¼šè¾“å‡º'1'ï¼Œreturn Promise.resolve('2')
// è¿™é‡Œä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å¾®ä»»åŠ¡ï¼ˆç­‰å¾…Promiseå®Œæˆï¼‰

// æ‰§è¡Œå¾®ä»»åŠ¡2ï¼šè¾“å‡º'3'ï¼Œæ³¨å†Œä¸‹ä¸€ä¸ªthen

// ç¬¬äºŒè½®å¾®ä»»åŠ¡
// Promise.resolve('2')å®Œæˆï¼Œä½†è¿˜éœ€è¦ä¸€ä¸ªå¾®ä»»åŠ¡æ¥å¤„ç†
.then(() => console.log('4'))

// ç¬¬ä¸‰è½®å¾®ä»»åŠ¡
.then(() => console.log('5'))

// ç¬¬å››è½®å¾®ä»»åŠ¡
.then(res => console.log(res)) // è¾“å‡º'2'
```

### 3. async/awaitæ‰§è¡Œé¡ºåº

```javascript
async function async1() {
  console.log('1');
  await async2();
  console.log('2'); // awaitåé¢çš„ä»£ç ç›¸å½“äºæ”¾åœ¨thené‡Œ
}

async function async2() {
  console.log('3');
}

console.log('4');

setTimeout(() => {
  console.log('5');
}, 0);

async1();

new Promise(resolve => {
  console.log('6');
  resolve();
}).then(() => {
  console.log('7');
});

console.log('8');

// è¾“å‡ºé¡ºåºï¼š4 -> 1 -> 3 -> 6 -> 8 -> 2 -> 7 -> 5
```

**è¯¦ç»†åˆ†æï¼š**
```javascript
// åŒæ­¥ä»£ç æ‰§è¡Œ
console.log('4');           // è¾“å‡ºï¼š4
setTimeout(...);            // å®ä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—
async1();                   // è¿›å…¥async1
  console.log('1');         // è¾“å‡ºï¼š1
  await async2();           // è¿›å…¥async2
    console.log('3');       // è¾“å‡ºï¼š3
  // awaitåé¢çš„ä»£ç å˜æˆå¾®ä»»åŠ¡
new Promise(...)
  console.log('6');         // è¾“å‡ºï¼š6
  resolve();                // thenå›è°ƒå˜æˆå¾®ä»»åŠ¡
console.log('8');           // è¾“å‡ºï¼š8

// å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š[async1çš„awaitåç»­, thenå›è°ƒ]
// æ‰§è¡Œå¾®ä»»åŠ¡
console.log('2');           // è¾“å‡ºï¼š2
console.log('7');           // è¾“å‡ºï¼š7

// å®ä»»åŠ¡
console.log('5');           // è¾“å‡ºï¼š5
```

---

## äºŒã€async/awaitä¸²è¡Œvså¹¶è¡Œ â­â­â­â­â­

### 1. ä¸²è¡Œæ‰§è¡Œï¼ˆæ…¢ï¼‰

```javascript
async function fetchDataSerial() {
  console.time('ä¸²è¡Œ');

  // è¯·æ±‚æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ€»è€—æ—¶ = å„è¯·æ±‚è€—æ—¶ä¹‹å’Œ
  const user = await fetchUser();    // 1ç§’
  const posts = await fetchPosts();  // 2ç§’
  const comments = await fetchComments(); // 1ç§’

  console.timeEnd('ä¸²è¡Œ'); // çº¦4ç§’

  return { user, posts, comments };
}

// æ¨¡æ‹Ÿè¯·æ±‚
function fetchUser() {
  return new Promise(resolve => {
    setTimeout(() => resolve({ name: 'å¼ ä¸‰' }), 1000);
  });
}

function fetchPosts() {
  return new Promise(resolve => {
    setTimeout(() => resolve([1, 2, 3]), 2000);
  });
}

function fetchComments() {
  return new Promise(resolve => {
    setTimeout(() => resolve(['å¥½è¯„', 'å·®è¯„']), 1000);
  });
}
```

### 2. å¹¶è¡Œæ‰§è¡Œï¼ˆå¿«ï¼‰â­â­â­â­â­

**æ–¹å¼1ï¼šPromise.all**
```javascript
async function fetchDataParallel1() {
  console.time('å¹¶è¡Œ1');

  // æ‰€æœ‰è¯·æ±‚åŒæ—¶å‘å‡ºï¼Œæ€»è€—æ—¶ = æœ€æ…¢è¯·æ±‚çš„è€—æ—¶
  const [user, posts, comments] = await Promise.all([
    fetchUser(),    // 1ç§’
    fetchPosts(),   // 2ç§’
    fetchComments() // 1ç§’
  ]);

  console.timeEnd('å¹¶è¡Œ1'); // çº¦2ç§’

  return { user, posts, comments };
}
```

**æ–¹å¼2ï¼šåŒæ—¶å‘èµ·ï¼Œåˆ†åˆ«await**
```javascript
async function fetchDataParallel2() {
  console.time('å¹¶è¡Œ2');

  // åŒæ—¶å‘èµ·è¯·æ±‚ï¼ˆä¸awaitï¼‰
  const userPromise = fetchUser();
  const postsPromise = fetchPosts();
  const commentsPromise = fetchComments();

  // å†åˆ†åˆ«awaitï¼ˆæ­¤æ—¶å·²ç»åœ¨å¹¶è¡Œæ‰§è¡Œäº†ï¼‰
  const user = await userPromise;
  const posts = await postsPromise;
  const comments = await commentsPromise;

  console.timeEnd('å¹¶è¡Œ2'); // çº¦2ç§’

  return { user, posts, comments };
}
```

### 3. æ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†ä¸²è¡Œï¼Œéƒ¨åˆ†å¹¶è¡Œ

```javascript
async function fetchDataMixed() {
  console.time('æ··åˆ');

  // ç¬¬ä¸€æ­¥ï¼šå…ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»å…ˆå®Œæˆï¼‰
  const user = await fetchUser(); // 1ç§’

  // ç¬¬äºŒæ­¥ï¼šæ ¹æ®ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶è¡Œè·å–postså’Œcomments
  const [posts, comments] = await Promise.all([
    fetchPosts(user.id),    // 2ç§’
    fetchComments(user.id)  // 1ç§’
  ]);

  console.timeEnd('æ··åˆ'); // çº¦3ç§’ï¼ˆ1 + 2ï¼‰

  return { user, posts, comments };
}
```

---

# ç¬¬å››éƒ¨åˆ†ï¼šäº‹ä»¶æœºåˆ¶è¿›é˜¶

## ä¸€ã€passiveæ€§èƒ½ä¼˜åŒ– â­â­â­â­â­

### 1. passiveçš„ä½œç”¨

```javascript
// âŒ é—®é¢˜ï¼šä¼ ç»Ÿæ»šåŠ¨ç›‘å¬ä¼šé˜»å¡
element.addEventListener('scroll', (e) => {
  // æµè§ˆå™¨ä¸çŸ¥é“è¿™é‡Œä¼šä¸ä¼šè°ƒç”¨e.preventDefault()
  // æ‰€ä»¥å¿…é¡»ç­‰å¾…è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œ
  // å¯¼è‡´æ»šåŠ¨å¡é¡¿
  doSomething();
});

// âœ… è§£å†³ï¼šä½¿ç”¨passiveå‘Šè¯‰æµè§ˆå™¨ä¸ä¼šé˜»æ­¢é»˜è®¤è¡Œä¸º
element.addEventListener('scroll', (e) => {
  // æµè§ˆå™¨å¯ä»¥ç«‹å³æ‰§è¡Œæ»šåŠ¨ï¼Œä¸ç”¨ç­‰å¾…
  doSomething();
}, { passive: true });

// âš ï¸ æ³¨æ„ï¼špassiveä¸ºtrueæ—¶ï¼Œe.preventDefault()ä¼šå¤±æ•ˆ
element.addEventListener('touchstart', (e) => {
  e.preventDefault(); // âŒ ä¸èµ·ä½œç”¨ï¼Œä¼šæŠ¥è­¦å‘Š
  doSomething();
}, { passive: true });
```

### 2. æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```javascript
// æµ‹è¯•1ï¼šä¸ä½¿ç”¨passiveï¼ˆå¡é¡¿ï¼‰
let count1 = 0;
document.addEventListener('scroll', () => {
  count1++;
  // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
  for (let i = 0; i < 1000000; i++) {}
  console.log('ä¸ä½¿ç”¨passive:', count1);
});

// æµ‹è¯•2ï¼šä½¿ç”¨passiveï¼ˆæµç•…ï¼‰
let count2 = 0;
document.addEventListener('scroll', () => {
  count2++;
  for (let i = 0; i < 1000000; i++) {}
  console.log('ä½¿ç”¨passive:', count2);
}, { passive: true });

// å¿«é€Ÿæ»šåŠ¨æµ‹è¯•ï¼Œä½¿ç”¨passiveçš„ç‰ˆæœ¬æ˜æ˜¾æ›´æµç•…
```

---

## äºŒã€keep-aliveç”Ÿå‘½å‘¨æœŸé’©å­ â­â­â­â­

### 1. activated vs mounted

```vue
<script setup>
import { onMounted, onActivated, onDeactivated, ref } from 'vue';

const data = ref(null);
const scrollPosition = ref(0);

// åªåœ¨é¦–æ¬¡æŒ‚è½½æ—¶æ‰§è¡Œ
onMounted(() => {
  console.log('ç»„ä»¶é¦–æ¬¡æŒ‚è½½');
  fetchData();
});

// æ¯æ¬¡æ¿€æ´»æ—¶æ‰§è¡Œï¼ˆåŒ…æ‹¬é¦–æ¬¡ï¼‰
onActivated(() => {
  console.log('ç»„ä»¶è¢«æ¿€æ´»');

  // æ¢å¤æ»šåŠ¨ä½ç½®
  window.scrollTo(0, scrollPosition.value);

  // åˆ·æ–°æ•°æ®
  refreshData();
});

// æ¯æ¬¡åœç”¨æ—¶æ‰§è¡Œ
onDeactivated(() => {
  console.log('ç»„ä»¶è¢«åœç”¨');

  // ä¿å­˜æ»šåŠ¨ä½ç½®
  scrollPosition.value = window.scrollY;

  // å–æ¶ˆæœªå®Œæˆçš„è¯·æ±‚
  cancelPendingRequests();
});

function fetchData() {
  // é¦–æ¬¡åŠ è½½æ•°æ®
}

function refreshData() {
  // åˆ·æ–°æ•°æ®ï¼ˆå¯èƒ½ä¸æ˜¯é¦–æ¬¡ï¼‰
}

function cancelPendingRequests() {
  // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
}
</script>
```

### 2. å®æˆ˜ï¼šåˆ—è¡¨é¡µç¼“å­˜

```vue
<!-- çˆ¶ç»„ä»¶ -->
<template>
  <keep-alive>
    <component :is="currentView"></component>
  </keep-alive>
</template>

<!-- åˆ—è¡¨ç»„ä»¶ -->
<script setup>
import { ref, onActivated, onDeactivated } from 'vue';

const list = ref([]);
const page = ref(1);
const scrollTop = ref(0);

// é¦–æ¬¡è¿›å…¥æˆ–ä»è¯¦æƒ…é¡µè¿”å›æ—¶è§¦å‘
onActivated(() => {
  console.log('åˆ—è¡¨é¡µæ¿€æ´»');

  // æ¢å¤æ»šåŠ¨ä½ç½®
  nextTick(() => {
    const container = document.querySelector('.list-container');
    if (container) {
      container.scrollTop = scrollTop.value;
    }
  });

  // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼ŒåŠ è½½æ•°æ®
  if (list.value.length === 0) {
    loadList();
  }
});

// è·³è½¬åˆ°è¯¦æƒ…é¡µæ—¶è§¦å‘
onDeactivated(() => {
  console.log('åˆ—è¡¨é¡µåœç”¨');

  // ä¿å­˜æ»šåŠ¨ä½ç½®
  const container = document.querySelector('.list-container');
  if (container) {
    scrollTop.value = container.scrollTop;
  }
});

function loadList() {
  // åŠ è½½åˆ—è¡¨æ•°æ®
}
</script>
```

---

# ç»¼åˆæ€»ç»“

## ğŸ“Š ç¬¬å››å¤©å­¦ä¹ å†…å®¹å›é¡¾

| ä¸»é¢˜ | æ ¸å¿ƒéš¾ç‚¹ | æŒæ¡è¦æ±‚ |
|------|----------|----------|
| **Vueå“åº”å¼** | Object.defineProperty vs Proxyå®ç°åŸç† | ç†è§£åº•å±‚æœºåˆ¶ |
| **JavaScriptè¿›é˜¶** | æ‰‹å†™call/apply/bindã€é—­åŒ…é«˜çº§åº”ç”¨ | èƒ½æ‰‹å†™å®ç° |
| **Promiseæ·±å…¥** | é“¾å¼è°ƒç”¨æ‰§è¡Œé¡ºåºã€ä¸²è¡Œvså¹¶è¡Œ | èƒ½åˆ†ææ‰§è¡Œæµç¨‹ |
| **äº‹ä»¶æœºåˆ¶** | passiveä¼˜åŒ–ã€keep-aliveé’©å­ | ç†è§£æ€§èƒ½ä¼˜åŒ– |

## ğŸ’¡ å­¦ä¹ å»ºè®®

### è¿›é˜¶è·¯çº¿
1. **æŒæ¡åº•å±‚åŸç†**ï¼šä¸åªæ˜¯ä¼šç”¨ï¼Œè¿˜è¦æ‡‚åŸç†
2. **æ‰‹å†™å®ç°**ï¼šé€šè¿‡æ‰‹å†™åŠ æ·±ç†è§£
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¼šåˆ†ææ€§èƒ½ç“¶é¢ˆ
4. **å®æˆ˜åº”ç”¨**ï¼šåœ¨é¡¹ç›®ä¸­åº”ç”¨è¿™äº›çŸ¥è¯†

### åç»­å­¦ä¹ æ–¹å‘
- äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ·±å…¥
- è™šæ‹ŸDOMå’Œdiffç®—æ³•
- Vuex/PiniaçŠ¶æ€ç®¡ç†
- TypeScriptè¿›é˜¶
- å·¥ç¨‹åŒ–å’Œæ„å»ºå·¥å…·

---

**ğŸ‰ å››å¤©å­¦ä¹ å®Œæˆï¼ä»åŸºç¡€åˆ°è¿›é˜¶ï¼Œä½ å·²ç»å…·å¤‡äº†æ‰å®çš„å‰ç«¯åŠŸåº•ï¼ç»§ç»­æ·±å…¥å­¦ä¹ ï¼Œå‘ä¸­é«˜çº§å·¥ç¨‹å¸ˆè¿ˆè¿›ï¼ğŸ’ª**
